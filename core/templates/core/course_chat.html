{% extends 'base.html' %}
{% block title %}Chat – {{ course.title }}{% endblock %}

{% block content %}
<h3 class="mb-3"><i class="bi bi-chat-dots"></i> {{ course.title }} – Chat</h3>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div id="log" class="p-3" style="height: 360px; overflow-y: auto; background: #f8f9fa;"></div>
    <div class="border-top p-3">
      <div class="input-group">
        <input id="msg" type="text" class="form-control" placeholder="Type a message and press Enter…">
        <button id="send" type="button" class="btn btn-primary"><i class="bi bi-send-fill"></i></button>
      </div>
    </div>
  </div>
</div>

<div class="mt-3">
  <a href="{% url 'my_courses' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to My Courses</a>
</div>

<script>
  const courseId = "{{ course.id }}";
  const scheme = location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${scheme}://${location.host}/ws/chat/${courseId}/`);

  const log   = document.getElementById("log");
  const input = document.getElementById("msg");
  const send  = document.getElementById("send");

  function addLine(html) {
    const div = document.createElement("div");
    div.className = "mb-2";
    div.innerHTML = html;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  socket.onopen  = () => addLine('<span class="text-success"><i class="bi bi-plug"></i> Connected.</span>');
  socket.onclose = () => addLine('<span class="text-danger"><i class="bi bi-x-octagon"></i> Disconnected.</span>');
  socket.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === "message") {
        addLine(`<strong>${data.user}</strong>: ${data.text}`);
      } else if (data.type === "system") {
        addLine(`<em>${data.text}</em>`);
      }
    } catch {}
  };

  function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;
    if (socket.readyState !== WebSocket.OPEN) {
      console.warn("WS not open, state=", socket.readyState);
      return;
    }
    // payload shape your consumer expects
    socket.send(JSON.stringify({ type: "message", text: msg }));
    input.value = "";
    input.focus();
  }

  // Hook up events (and prevent accidental form submit)
  send.addEventListener("click", (e) => { e.preventDefault(); sendMessage(); });
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); sendMessage(); }
  });
</script>

{% endblock %}
